# Пошаговое Устранение Проблем с Виджетом "Похожий контент" для InstantCMS 2.17.2

В данном документе описаны шаги по диагностике и решению проблем, возникших при актуализации виджета "Похожий контент" (автор: Loadырь, версия 2.0) для работы на InstantCMS 2.17.2 с PHP 7.4.x.

## Этап 1: Первичная Установка и Диагностика Базовых Проблем

Цель этого этапа — установить виджет и выявить основные проблемы, мешающие его корректной инициализации и базовой работе.

### 1.1. Процесс Установки (Как проводился)

1.  **Включение режима отладки:** В административной панели InstantCMS был включен режим отладки для отображения всех ошибок PHP.
2.  **Установка пакета:** Пакет виджета "Похожий контент" был установлен через стандартный менеджер дополнений. Система сообщила об успешной установке.

### 1.2. Проблема 1: Отсутствие таблицы `cms_relevants` в Базе Данных

* **Симптомы:**
    * Несмотря на сообщение об успешной установке, таблица `cms_relevants`, необходимая для работы компонента, не была создана в базе данных.
    * В административной панели компонент "Похожий контент" появился, но при попытке перейти на его страницу возникала ошибка 503.
    * При попытке создать "релевант" (сущность компонента) возникала ошибка БД: `Таблица 'имя_вашей_бд.cms_relevants' не существует`.
* **Предполагаемая причина:**
    * Скрипт `install.php` не смог выполнить команду `CREATE TABLE` из-за недостаточных прав у пользователя БД или других "тихих" ошибок SQL, которые не прервали общий процесс установки. Запись о самом компоненте (контроллере) в таблицу `cms_controllers` при этом была успешно добавлена.
* **Решение:**
    * Таблица `cms_relevants` была создана вручную путем выполнения следующего SQL-запроса (префикс `cms_` может отличаться):

        ```sql
        CREATE TABLE IF NOT EXISTS `cms_relevants` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `name` varchar(20) DEFAULT NULL,
            `title` varchar(100) DEFAULT NULL,
            `description` varchar(255) DEFAULT NULL,
            `is_visible` tinyint(1) DEFAULT NULL,
            `content` text DEFAULT NULL,
            `template` text DEFAULT NULL,
            `fulltext` text DEFAULT NULL,
            `filters` text DEFAULT NULL,
            `sorting` text DEFAULT NULL,
            PRIMARY KEY (`id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Таблица c фильтрами похожего контента' AUTO_INCREMENT=1;
        ```
    * **Результат:** После этого ошибка 503 исчезла, и появилась возможность успешно создавать и сохранять "релеванты".

### 1.3. Проблема 2: Отсутствие Виджета в Системе

* **Симптомы:**
    * После решения проблемы с таблицей `cms_relevants` выяснилось, что сам виджет "Похожий контент" не появился в списке доступных виджетов в административной панели (ПУ -> Виджеты).
    * В таблице `cms_widgets` отсутствовала соответствующая запись.
* **Предполагаемая причина:**
    * Аналогично предыдущей проблеме, команда `INSERT INTO \`{#}widgets\` ...` в скрипте `install.php` не была выполнена корректно во время автоматической установки.
* **Решение:**
    * Запись о виджете была добавлена в таблицу `cms_widgets` вручную с помощью SQL-запроса:

        ```sql
        INSERT INTO `cms_widgets` (`controller`, `name`, `title`, `author`, `url`, `version`) 
        VALUES ('relevanter', 'relevants', 'Похожий контент', 'Loadырь', '[http://www.instantcms.ru/users/loadir](http://www.instantcms.ru/users/loadir)', '2.0');
        ```
    * **Результат:** После выполнения запроса и очистки кеша InstantCMS виджет появился в списке доступных.

### 1.4. Проблема 3: Ошибка FULLTEXT Индекса при Работе Виджета

* **Симптомы:**
    * После установки виджета на страницу сайта (например, на страницу записи типа контента "Новости") и его срабатывания, возникала ошибка БД: `Невозможно отыскать полнотекстовый (FULLTEXT) индекс, соответствующий списку столбцов`.
    * Ошибка указывала на SQL-запрос, использующий `MATCH (i.title, i.seo_keys) AGAINST (...)` для таблицы типа контента (например, `cms_con_news`).
* **Причина:**
    * Для таблицы типа контента (`cms_con_news`) отсутствовал составной `FULLTEXT` индекс, включающий одновременно поля `title` и `seo_keys`. Существующие FULLTEXT-индексы были только для поля `title`.
    * Стандартный интерфейс настройки полей типа контента в InstantCMS не предоставлял возможности включить поле `seo_keys` (Ключевые слова) в полнотекстовый индекс.
* **Решение:**
    * Составной `FULLTEXT` индекс для полей `title` и `seo_keys` был создан вручную для таблицы `cms_con_news` с помощью SQL-запроса:

        ```sql
        ALTER TABLE cms_con_news ADD FULLTEXT INDEX ft_title_seo_keys (title, seo_keys);
        ```
    * **Результат:** После создания индекса и очистки кеша виджет начал корректно подбирать и выводить похожие статьи.

### 1.5. Проблема 4: PHP Notice "Trying to access array offset on value of type bool"

* **Симптомы:**
    * После решения проблемы с FULLTEXT-индексом, при отображении виджета на сайте (с *включенным* режимом отладки) появлялось PHP Notice: `Notice: Trying to access array offset on value of type bool in .../system/controllers/relevanter/hooks/relevant_events.php on line 152`.
    * Строка 152 в оригинальном коде соответствовала `$items_all = $cache->get($cache_key);`.
* **Предполагаемая причина:**
    * Уведомление возникало из-за того, что метод `$cache->get()` (или его внутренние операции) для определенного ключа кеша сталкивался с некорректным значением (возможно, `false` или поврежденными данными) и пытался обработать его как массив.
* **Решение/Статус:**
    * После **отключения режима отладки** в административной панели InstantCMS, данное уведомление (Notice) перестало отображаться.
    * Это стандартное поведение, так как `Notice` не являются критическими ошибками и скрываются при обычном режиме работы сайта. Очистка системного кеша была рекомендована как первый шаг при подобных проблемах.

### 1.6. Проблема 5: Некорректная Сортировка Записей

* **Симптомы:**
    * Записи в виджете выводились по ID в порядке возрастания, игнорируя настройки сортировки, заданные в "релеванте".
* **Причина:**
    * Некорректная логика применения сортировки в файле `system/controllers/relevanter/hooks/relevant_events.php`. Отсутствие явной сортировки по умолчанию или неправильное переопределение сортировки по релевантности (при полнотекстовом поиске) приводило к "естественному" порядку вывода из БД.
* **Решение:**
    * Файл `system/controllers/relevanter/hooks/relevant_events.php` был модифицирован для корректной обработки сортировки:
        1.  Введена переменная для отслеживания явно примененной сортировки (`$is_explicit_sorting_applied`).
        2.  Сортировка из настроек "релеванта" (`$sorting_rules`) теперь корректно переопределяет другие сортировки (включая сортировку по релевантности `REL DESC` от полнотекстового поиска).
        3.  Реализована сортировка по умолчанию (если никакая другая не применена): сначала по полю `date_pub` (по убыванию), если оно доступно и активно, иначе по полю `id` (по убыванию).
        4.  Устранен ошибочный вызов несуществующего метода `getTableAlias()`, заменен на использование стандартного алиаса таблицы `'i'`.
    * **Результат:** После применения исправленного файла и очистки кеша сортировка заработала корректно.

## Этап 2: Рекомендации по Улучшению `install.php`

Хотя основные проблемы были решены ручным вмешательством, для повышения надежности установочного скрипта `install.php` рекомендуется внести следующие улучшения:

1.  **Проверка результата выполнения каждого SQL-запроса:** Использовать результат `$db->query()` для определения успеха операции.
2.  **Возврат `false` из `install_package()` при ошибке:** Это позволит системе InstantCMS корректно идентифицировать неудачную установку.
3.  **Добавление сообщений об ошибках через `cmsUser::addSessionMessage()`:** Для информирования администратора о конкретной проблеме.
4.  **Явная проверка существования таблицы после `CREATE TABLE`** с помощью `$db->isTableExists('имя_таблицы')`.
5.  **Очистка кеша схемы таблиц (`$db->clearCache(); cmsCache::getInstance()->clean('db_schema');`) в конце успешной установки.**

*Пример улучшенного кода `install.php` был предоставлен и протестирован в ходе решения проблем.*

## Этап 3: Всестороннее Тестирование Функциональности

После устранения вышеописанных проблем, следующим шагом является детальное тестирование всех аспектов работы виджета:
* Настройки "релевантов" в административной панели (все вкладки и опции).
* Корректность подбора и отображения похожих записей на сайте в различных сценариях (разные типы контента, категории, настройки полнотекстового поиска, фильтры, сортировка).
* Соответствие вывода на сайте выбранному шаблону и его настройкам.
* Отсутствие PHP-ошибок (периодически включая режим отладки).
* Общая стабильность работы.

Это позволит выявить любые оставшиеся недочеты или ошибки в логике работы виджета.
