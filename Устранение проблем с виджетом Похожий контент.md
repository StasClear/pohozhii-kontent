# Пошаговое Устранение Проблем с Виджетом "Похожий контент" для InstantCMS 2.17.2

В данном документе описаны шаги по диагностике и решению проблем, возникших при актуализации виджета "Похожий контент" (автор: Loadырь, версия 2.0) для работы на InstantCMS 2.17.2 с PHP 7.4.x.

## Шаг 1: Первичная Установка и Диагностика Базовых Проблем

Цель этого шага — установить виджет и выявить основные проблемы, мешающие его корректной инициализации.

### 1.1. Процесс Установки

1.  **Включение режима отладки:** В административной панели InstantCMS был включен режим отладки для отображения всех ошибок PHP.
2.  **Установка пакета:** Пакет виджета "Похожий контент" был установлен через стандартный менеджер дополнений. Система сообщила об успешной установке.

### 1.2. Проблема 1: Отсутствие таблицы `cms_relevants` в Базе Данных

* **Симптомы:**
    * Несмотря на сообщение об успешной установке, таблица `cms_relevants`, необходимая для работы компонента, не была создана в базе данных.
    * В административной панели компонент "Похожий контент" появился, но при попытке перейти на его страницу возникала ошибка 503.
    * При попытке создать "релевант" (сущность компонента) возникала ошибка БД: `Таблица 'имя_вашей_бд.cms_relevants' не существует`.
* **Причина:**
    * Наиболее вероятно, скрипт `install.php` не смог выполнить команду `CREATE TABLE` из-за недостаточных прав у пользователя БД или других "тихих" ошибок SQL, которые не прервали общий процесс установки. Запись о самом компоненте (контроллере) в таблицу `cms_controllers` при этом была успешно добавлена.
* **Решение:**
    * Таблица `cms_relevants` была создана вручную путем выполнения следующего SQL-запроса (префикс `cms_` может отличаться):

      ```sql
      CREATE TABLE IF NOT EXISTS `cms_relevants` (
          `id` int(11) NOT NULL AUTO_INCREMENT,
          `name` varchar(20) DEFAULT NULL,
          `title` varchar(100) DEFAULT NULL,
          `description` varchar(255) DEFAULT NULL,
          `is_visible` tinyint(1) DEFAULT NULL,
          `content` text DEFAULT NULL,
          `template` text DEFAULT NULL,
          `fulltext` text DEFAULT NULL,
          `filters` text DEFAULT NULL,
          `sorting` text DEFAULT NULL,
          PRIMARY KEY (`id`)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Таблица c фильтрами похожего контента' AUTO_INCREMENT=1;
      ```
    * После этого ошибка 503 исчезла, и появилась возможность успешно создавать и сохранять "релеванты".

### 1.3. Проблема 2: Отсутствие Виджета в Системе

* **Симптомы:**
    * После решения проблемы с таблицей `cms_relevants` выяснилось, что сам виджет "Похожий контент" не появился в списке доступных виджетов в административной панели (ПУ -> Виджеты).
    * В таблице `cms_widgets` отсутствовала соответствующая запись.
* **Причина:**
    * Аналогично предыдущей проблеме, команда `INSERT INTO \`{#}widgets\` ...` в скрипте `install.php` не была выполнена корректно во время автоматической установки.
* **Решение:**
    * Запись о виджете была добавлена в таблицу `cms_widgets` вручную с помощью SQL-запроса:

      ```sql
      INSERT INTO `cms_widgets` (`controller`, `name`, `title`, `author`, `url`, `version`) 
      VALUES ('relevanter', 'relevants', 'Похожий контент', 'Loadырь', '[http://www.instantcms.ru/users/loadir](http://www.instantcms.ru/users/loadir)', '2.0');
      ```
    * После выполнения запроса и очистки кеша InstantCMS виджет появился в списке доступных.

### 1.4. Проблема 3: Ошибка FULLTEXT Индекса при Работе Виджета

* **Симптомы:**
    * После установки виджета на страницу сайта (например, на страницу записи типа контента "Новости") и его срабатывания, возникала ошибка БД: `Невозможно отыскать полнотекстовый (FULLTEXT) индекс, соответствующий списку столбцов`.
    * Ошибка указывала на SQL-запрос, использующий `MATCH (i.title, i.seo_keys) AGAINST (...)` для таблицы типа контента (например, `cms_con_news`).
* **Причина:**
    * Для таблицы типа контента (`cms_con_news`) отсутствовал составной `FULLTEXT` индекс, включающий одновременно поля `title` и `seo_keys`. Существующие FULLTEXT-индексы были только для поля `title`.
    * Стандартный интерфейс настройки полей типа контента в InstantCMS не предоставлял возможности включить поле `seo_keys` (Ключевые слова) в полнотекстовый индекс.
* **Решение:**
    * Составной `FULLTEXT` индекс для полей `title` и `seo_keys` был создан вручную для таблицы `cms_con_news` с помощью SQL-запроса:

      ```sql
      ALTER TABLE cms_con_news ADD FULLTEXT INDEX ft_title_seo_keys (title, seo_keys);
      ```
    * После создания индекса и очистки кеша виджет начал корректно подбирать и выводить похожие статьи.

### 1.5. Проблема 4: PHP Notice "Trying to access array offset on value of type bool"

* **Симптомы:**
    * После решения проблемы с FULLTEXT-индексом, при отображении виджета на сайте (с *включенным* режимом отладки) появлялось PHP Notice: `Notice: Trying to access array offset on value of type bool in .../system/controllers/relevanter/hooks/relevant_events.php on line 152`.
    * Строка 152 соответствовала `$items_all = $cache->get($cache_key);`.
* **Причина:**
    * Уведомление возникало из-за того, что метод `$cache->get()` (или его внутренние операции, например, при десериализации) для определенного ключа кеша (`$cache_key`) сталкивался с некорректным значением (возможно, `false` или поврежденными данными) и пытался обработать его как массив.
* **Решение/Статус:**
    * После **отключения режима отладки** в административной панели InstantCMS, данное уведомление (Notice) перестало отображаться. Это стандартное поведение, так как `Notice` не являются критическими ошибками и скрываются при обычном режиме работы сайта.
    * Предварительно была рекомендована очистка системного кеша, что является стандартной процедурой при подобных проблемах с кешированием.
    * Поскольку ошибка не видна при обычном режиме работы и виджет функционирует, активных действий по исправлению кода для этого конкретного `Notice` можно не предпринимать, но стоит помнить о важности регулярной очистки кеша при возникновении необъяснимого поведения.

## Шаг 2: Рекомендации по Улучшению `install.php` (Опционально, но Рекомендуется)

Хотя основные проблемы были решены ручным вмешательством, для повышения надежности установочного скрипта `install.php` были предложены следующие улучшения:

1.  **Проверка результата выполнения каждого SQL-запроса:** Использовать результат `$db->query()` для определения успеха операции.
2.  **Возврат `false` из `install_package()` при ошибке:** Это позволит системе InstantCMS корректно идентифицировать неудачную установку.
3.  **Добавление сообщений об ошибках через `cmsUser::addSessionMessage()`:** Для информирования администратора о конкретной проблеме.
4.  **Очистка кеша схемы таблиц (`$db->clearCache(); cmsCache::getInstance()->clean('db_schema');`) в конце успешной установки.**

Пример улучшенного кода `install.php` был предоставлен в ходе обсуждения.

## Шаг 3: Всестороннее Тестирование Функциональности

После устранения вышеописанных проблем, следующим шагом является детальное тестирование всех аспектов работы виджета:
* Настройки "релевантов" в административной панели.
* Корректность подбора и отображения похожих записей на сайте в различных сценариях.
* Совместимость с PHP 7.4.x и InstantCMS 2.17.2.

Это позволит выявить любые оставшиеся недочеты или ошибки в логике работы виджета.
